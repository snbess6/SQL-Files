CREATE TABLE billing (
    patient_id INTEGER
  	, insurance_provider TEXT
    , procedure_code INTEGER
    , procedure_description TEXT
    , procedure_cost REAL
    , procedure_bill REAL
    , payment_received REAL
);


INSERT INTO billing (patient_id, insurance_provider, procedure_code, procedure_description, procedure_cost, procedure_bill, payment_received)
VALUES
    (137845, 'Insurance A', 42213, 'Office Visit', 335.00, 83.75, 35.00)
  , (187738, 'Insurance C', 85706, 'ECG', 425.00, 63.75, 50.00)
  , (214007, 'Insurance A', 80048, 'Basic Metabolic Panel', 200.00, 50.00, 0.00)
  , (250077, 'Insurance B', 80525, 'Complete Blood Count', 225.00, 78.75, 0.00)
  , (281938, 'Insurance B', 80449, 'Glucose Tolerance Test', 150.00, 52.50, 15.00)
  , (296309, 'Insurance C', 42213, 'Office Visit', 335.00, 50.25, 30.00)
  , (301544, 'Insurance C', 80061, 'Lipid Panel', 135.00, 20.25, 20.25)
  , (390731, 'Insurance B', 80449, 'Glucose Tolerance Test', 150.00, 52.50, 0.00)
    ;

-- Display the patient ID and create a new column that calculates how much each patient still needs to pay. Call the new column payment_remaining.
SELECT patient_id, procedure_bill - payment_received AS payment_remaining
FROM billing;

--Select every patient ID, the procedure bill, and create a new column that calculates the fraction of what the patient has paid toward their procedure bill. Call the new column payment_fraction and sort it from low to high.
SELECT patient_id
, procedure_bill
, payment_received / procedure_bill AS payment_fraction
FROM billing
ORDER BY payment_fraction;

--Display the patient ID, payment_fraction, and add a column displaying the percent of the bill that the patient has paid, rounded to one place. Call the new column payment_percent.
SELECT patient_id
, payment_received / procedure_bill AS payment_fraction
, ROUND((payment_received / procedure_bill)*100, 1) AS payment_percent
FROM billing;

--Display the patient ID, the payment_fraction column from query #2, and a new column titled payment_status, which categorizes the payment_fraction column into three categories: For 100% payment, write “paid”. If the payment is less than 100% but more than 0%, use “in progress”. If the patient hasn’t made a payment, write “no payment”.
SELECT patient_id
, payment_received / procedure_bill AS payment_fraction
, CASE
WHEN (payment_received / procedure_bill) = 1 THEN "PAID"
WHEN (payment_received / procedure_bill) = 0 THEN "NO PAYMENT"
ELSE "IN PROGRESS"
END AS payment_status
FROM billing;

--Alter the previous query to create more categories in payment_status.
SELECT patient_id
, payment_received / procedure_bill AS payment_fraction
, CASE
WHEN (payment_received / procedure_bill) = 1 THEN "PAID"
WHEN (payment_received / procedure_bill) = 0 THEN "NO PAYMENT"
WHEN (payment_received / procedure_bill) >= 0.75 THEN "75%+"
WHEN (payment_received / procedure_bill) >= 0.50 THEN "50%+"
WHEN (payment_received / procedure_bill) >= 0.25 THEN "25%+"
WHEN (payment_received / procedure_bill) < 0.25 THEN "Under 25%"
ELSE "IN PROGRESS"
END AS payment_status
FROM billing;

--See each patient's total remaining payment, accounting for multiple bills
SELECT patient_id 
, SUM(procedure_bill) - payment_received AS payment_remaining 
FROM billing
GROUP BY patient_id;

--Show only patients with more than $150 remaining on their payment are displayed.
SELECT patient_id 
, SUM(procedure_bill) - payment_received AS payment_remaining 
FROM billing
GROUP BY patient_id
HAVING payment_remaining >= 150;

--Display the insurance providers and the number of patient bills covered by each provider for lab tests (lab test procedure codes all begin with “80”). Call the new column lab_bills.
SELECT insurance_provider
,COUNT(procedure_bill) AS lab_bills
FROM billing
WHERE procedure_code LIKE '80%'
GROUP BY insurance_provider;

-- Display only insurance companies that have billed more than 3 lab procedures.
SELECT insurance_provider
,COUNT(procedure_bill) AS lab_bills
FROM billing
WHERE procedure_code LIKE '80%' 
HAVING COUNT(procedure_bill) >3;
